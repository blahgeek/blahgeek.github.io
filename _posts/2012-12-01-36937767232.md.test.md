---
permalink: zhe-zong-suan-shi-chong-bi-jiao-you-mei-de-fang-an-liao.html
layout: post
title: 这总算是一种比较优美的方案了...
tags: google VPN GFW route DNS
---

>之前采用的是在本地搭建DNS服务器，加上使用IPv6，实在不行还能连VPN，说实话墙对于我来说已经可以认为不存在了。但终归感觉不是很优美，切换略麻烦。于是总结出这样的方法。其实这种时候翻墙已经不是因为某个需要的网站上不去了，而是对墙的一种反抗...而且要以优美的方式...

总结一下，墙内用户（特别是教育网用户）的需求是：

1. 对于国内大型常用网站如renren, tudou等：由于CDN的存在，所以需要使用运营商提供的DNS解析，然后正常访问。
2. 对于国内其他网站：使用任意DNS解析（用运营商提供的最好），然后正常访问。
3. 对于国外被墙网站：由于DNS劫持的存在，需要用国外DNS解析，又由于DNS污染的存在，即使把DNS服务器改为国外DNS，还是无法得到正确的地址，需要通过VPN解析，然后通过VPN访问。
4. 对于Google服务：使用Google北京数据中心的IP。（详见[这里](http://blahgeek.com/post/35242450062)）
5. 对于国外其他网站：正常访问或者通过VPN访问。
6. 对于支持IPv6的网站：使用isatap正常访问，但是一些域名的AAAA记录也会被DNS劫持/污染，因此需要通过VPN向国外DNS解析。

尝试了几天后，一个比较好的而且比较优美的但肯定不是最完美的解决方法如下：
（这里说的是拥有一个墙外主机（以下称为server）的解决方法。）

首先在server上用比如dnsmasq配置DNS服务器，配置为：

- 对于所有Google服务，返回北京数据中心IP。
- 对于上述第一种情况，向国内运营商DNS查询（教育网很多DNS不会响应教育网外的请求，一个可用的DNS是202.38.64.1）。
- 对于其他情况，向server的运营商提供的DNS查询。

第一种情况的网站的常用列表配置如下：

```
server=/renren.com/202.38.64.1
server=/apple.com/202.38.64.1
server=/qq.com/202.38.64.1
server=/alipay.com/202.38.64.1
server=/alipayobjects.com/202.38.64.1
server=/xunlei.com/202.38.64.1
server=/sougou.com/202.38.64.1
server=/xnimg.com/202.38.64.1
server=/taobao.com/202.38.64.1
server=/tmall.com/202.38.64.1
server=/alipay.com/202.38.64.1
server=/baidu.com/202.38.64.1
server=/tudou.com/202.38.64.1
server=/tudouui.com/202.38.64.1
server=/ku6cdn.com/202.38.64.1
server=/ku6.com/202.38.64.1
server=/163.com/202.38.64.1
server=/tdimg.com/202.38.64.1
server=/youku.com/202.38.64.1
server=/cn/202.38.64.1 #所有cn结尾的域名

```
Google服务的配置大概是这样的（不写IP的原因是因为用的人太多了马上会导致被封..上次就出现过这种情况了...真的想要知道的同学应该也不难知道...）：

```
address=/google.com/<Google Beijing IP>
address=/goo.gl/<Google Beijing IP>
address=/google-analytics.com/<Google Beijing IP>
# and more...

```
然后在server上配置OpenVPN，使用tcp协议443端口（我就不信这个端口也会被XX）。把客户端的DNS设为该server（是VPN隧道内的内网地址，不是外网地址，以防止DNS污染）。

再然后，通过OpenVPN配置路由表，使所有国内网段通过正常接口访问，其他通过VPN访问。这个路由表本来有近一万行（因为我国被分配到的IP段太散了），然后由于路由表是匹配更精确的条目，因此能通过某算法精简，见[这里](http://ashi009.tumblr.com/post/36581070478/vpn)，能减少到约1000条。具体配置可能有一些细节问题，自己尝试几次就好。

于是服务器端的OpenVPN配置大概是这样的：

```
max-routes 2000
server 10.8.0.0 255.255.255.0
push "redirect-gateway def1"

push "route 0.0.0.0 254.0.0.0 net_gateway"
push "route 1.0.16.0 255.255.240.0 vpn_gateway"
push "route 1.0.64.0 255.255.192.0 vpn_gateway"
push "route 1.1.64.0 255.255.192.0 vpn_gateway"
push "route 1.5.0.0 255.255.0.0 vpn_gateway"
;
; and much much more....
;
push "route 223.222.0.0 255.254.0.0 vpn_gateway"
push "route 223.223.176.0 255.255.240.0 net_gateway"
push "route 223.223.192.0 255.255.240.0 net_gateway"
push "route 223.255.128.0 255.255.192.0 vpn_gateway"
push "route 223.255.240.0 255.255.248.0 vpn_gateway"

push "dhcp-option DNS 10.8.0.1"

```
另外，对于通过isatap使用的IPv6，由于isatap服务器显然是属于国内的IP段的，因此完全不影响。而且由于DNS使用的是国外的，一些原生支持IPv6的网站如facebook就可以用IPv6直接访问了。

至此，以上六条需求完全满足。

PS：在不使用VPN的时候，把DNS服务器设置为server也很方便，因为测试发现向境外服务器查询大多数google的域名是不会被污染的。这样就省下了在本地跑一个dnsmasq的资源，虽然延时会多几百毫秒。

PPS：可惜路由表的加载略慢，虽然精简到了一千多条，整个启动过程在电脑上还是需要十多秒，不过还好只要在开机时候启动即可，没有必要推出，毕竟不会影响国内网站访问速度，但是iPhone就比较难办了（使用的是GuizmOVPN），加载路由表等要花几分钟时间，暂时没找到什么好方法。

o

